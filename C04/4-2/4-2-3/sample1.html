<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="user-scalable=no,initial-scale=1" />
<title>4-2-3sample</title>
<script type="text/javascript" src="http://maps.googleapis.com/maps/api/js?sensor=true&libraries=places"></script><!--//(1)-->
<script type="text/javascript">
var markersArray= new Array();
var map;
var infowindow;
var currentInfoWindow = null;

function initialize(){
//地図表示と現在位置取得
	map = new google.maps.Map(
		document.getElementById("gmap"),{
			zoom : 14,
			center : new google.maps.LatLng(35.68916, 139.70083),
			mapTypeControlOptions : {
			       style : google.maps.MapTypeControlStyle.DROPDOWN_MENU
			},
			navigationControlOptions : {
				style : google.maps.NavigationControlStyle.SMALL
			},
			scaleControl:true,
			scaleControlOptions : {
			       style : google.maps.ScaleControlStyle.DEFAULT
			},
			mapTypeId : google.maps.MapTypeId.ROADMAP
		}
	);
	//位置情報を取得する
	if(navigator.geolocation){//1
		navigator.geolocation.getCurrentPosition(function(pos){
			var lat = pos.coords.latitude;
			var lng = pos.coords.longitude;
			var currentPos = new google.maps.LatLng(lat, lng);
			map.setCenter(currentPos);
		},
		function(error){alert('error:'+error.code);},
		{enableHighAccuracy:false,timeout:8000,maximumAge:0}
		);
	}
	//アドレスバーを隠す
	setTimeout(scrollTo, 100, 0, 1);
}
function getData(){
	clearOverlays();
	var request = {//(7)
		location: map.getCenter(),
		radius: 1000,
		types: ['store']
	};
	infowindow = new google.maps.InfoWindow();
	if (currentInfoWindow) {
		currentInfoWindow.close();//6
	}
	var service = new google.maps.places.PlacesService(map);//3
	service.search(request, callback);
}

function callback(results, status) {
  if (status == google.maps.places.PlacesServiceStatus.OK) {
    for (var i = 0; i < results.length; i++) {
      createMarker(results[i]);//4
    }
  }
}

function createMarker(place) {
  var placeLoc = place.geometry.location;
  var marker = new google.maps.Marker({
    map: map,
		draggable:true,
		title:place.name,
		animation: google.maps.Animation.DROP,
    position: place.geometry.location
  });

  google.maps.event.addListener(marker, 'click', function() {
    infowindow.setContent(place.name);
    infowindow.open(map, this);
		currentInfoWindow = infowindow;
  });
	markersArray.push(marker);
}

function clearOverlays() {//(5)
	for (i in markersArray) {
		markersArray[i].setMap(null);
	}
	markersArray=[];
}
google.maps.event.addDomListener(window,"load",initialize);

//2:ボタン追加
window.onload = function(){
	document.getElementById("getbtn").innerHTML = "<img src='btn.gif' id='getData'>";
	document.getElementById("getData").addEventListener("click", getData,true);
}
</script>
<style type="text/css" />
#gmap {position:absolute;width:100%;height:100%;}
#getbtn {position : absolute;left:5px;top:250px;}
</style>
</head>
<body>
<div id="gmap"></div> 
<div id="getbtn"></div> 
</body>
</html>
